<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tickets - Exportación de Café S.A. de C.V.</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDF8F5; /* Lighter Creamy Beige */
            color: #4A3B31; /* Darker, Richer Brown for text */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar-custom {
            background-color: #4A3B31; /* Darker, Richer Brown */
        }
        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link,
        .navbar-custom .user-info { /* Apply to user-info as well */
            color: #E0D6CC; /* Soft, Light Beige */
        }
        .navbar-custom .nav-link:hover,
        .navbar-custom .navbar-brand:hover {
            color: #FFFFFF;
        }
        .btn-primary-custom {
            background-color: #795548; /* Brown Sugar */
            border-color: #795548;
            color: #FFFFFF;
        }
        .btn-primary-custom:hover {
            background-color: #5D4037; /* Darker Brown Sugar */
            border-color: #5D4037;
        }
        .btn-secondary-custom {
            background-color: #8D6E63; /* Pale Taupe */
            border-color: #8D6E63;
            color: #FFFFFF;
        }
        .btn-secondary-custom:hover {
            background-color: #6D4C41; /* Darker Pale Taupe */
            border-color: #6D4C41;
        }
        .btn-danger-custom {
            background-color: #C62828; /* Stronger Red for delete */
            border-color: #C62828;
            color: #FFFFFF;
        }
        .btn-danger-custom:hover {
            background-color: #B71C1C;
            border-color: #B71C1C;
        }
        .card {
            border: 1px solid #C5B8AE; /* Muted Tan Border */
            border-radius: 0.75rem; /* Slightly more rounded */
            margin-bottom: 1.25rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .card-header-custom {
            background-color: #A1887F; /* Medium Brown */
            color: #FFFFFF; /* White text on card header */
            font-weight: 500; /* Medium weight */
            border-bottom: none;
            border-top-left-radius: calc(0.75rem - 1px);
            border-top-right-radius: calc(0.75rem - 1px);
        }
        .form-control:focus, .form-select:focus {
            border-color: #795548;
            box-shadow: 0 0 0 0.25rem rgba(121, 85, 72, 0.25);
        }
        .priority-alta { color: #E57373; font-weight: 500; } /* Softer Red */
        .priority-media { color: #FFB74D; font-weight: 500; } /* Softer Orange/Yellow */
        .priority-baja { color: #81C784; font-weight: 500; } /* Softer Green */

        .status-abierto {
            background-color: #66BB6A; /* Softer Green Badge */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-cerrado {
            background-color: #BDBDBD; /* Neutral Grey Badge */
            color: #424242; /* Darker text for grey badge */
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .auth-container {
            max-width: 420px; /* Slightly wider */
            margin: 60px auto;
            padding: 30px; /* More padding */
            background-color: #FFFFFF;
            border-radius: 12px; /* More rounded */
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        .main-app-container {
            padding-top: 25px;
            padding-bottom: 40px;
        }
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1060; /* Higher z-index */
        }
        .footer-custom {
            background-color: #4A3B31;
            color: #E0D6CC;
            padding: 1.25rem 0;
            margin-top: auto;
            text-align: center;
            font-size: 0.9rem;
        }
        .user-info {
            /* color already set by .navbar-custom .user-info */
            font-weight: 500;
        }
        .btn i {
            margin-right: 0.4rem;
        }
        .page-title {
            color: #3B2F2F;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .section-title {
            color: #4A3B31;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .modal-header.card-header-custom .modal-title {
             color: #FFFFFF; /* Ensure modal title is white if header is dark */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-seedling"></i> Exportación de Café S.A. de C.V.</a>
            <div id="userInfo" class="ms-auto me-3 user-info d-none"></div>
            <button id="logoutButton" class="btn btn-outline-light d-none"><i class="fas fa-sign-out-alt"></i> Salir</button>
        </div>
    </nav>

    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary-custom" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <div id="authSection" class="container">
        <div class="auth-container">
            <div id="loginFormContainer">
                <h3 class="text-center mb-4 page-title"><i class="fas fa-coffee me-2"></i>Iniciar Sesión</h3>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100 mt-2"><i class="fas fa-sign-in-alt"></i> Entrar</button>
                </form>
                <p class="mt-3 text-center">
                    <a href="#" id="showRegister">Registrar nuevo empleado</a> | <a href="#" id="showPasswordReset">Olvidé mi contraseña</a>
                </p>
            </div>

            <div id="registerFormContainer" style="display: none;">
                <h3 class="text-center mb-4 page-title"><i class="fas fa-user-edit me-2"></i>Registrar Empleado</h3>
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerName" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="registerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="registerPassword" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100 mt-2"><i class="fas fa-user-plus"></i> Registrar</button>
                </form>
                <p class="mt-3 text-center">
                    <a href="#" id="showLoginFromRegister">Ya tengo cuenta</a>
                </p>
            </div>

            <div id="passwordResetFormContainer" style="display: none;">
                <h3 class="text-center mb-4 page-title"><i class="fas fa-unlock-alt me-2"></i>Recuperar Contraseña</h3>
                <form id="passwordResetForm">
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn btn-primary-custom w-100 mt-2"><i class="fas fa-key"></i> Enviar enlace</button>
                </form>
                <p class="mt-3 text-center">
                    <a href="#" id="showLoginFromReset">Volver a Iniciar Sesión</a>
                </p>
            </div>
             <div id="authMessage" class="alert mt-3" style="display:none;"></div>
        </div>
    </div>

    <div id="appSection" class="container main-app-container" style="display: none;">
        <h2 class="mb-4 page-title"><i class="fas fa-tasks me-2"></i>Panel de Gestión de Tickets</h2>

        <div class="row mb-4 align-items-center">
            <div class="col-md-auto mb-2 mb-md-0">
                 <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#createTicketModal"><i class="fas fa-plus-circle"></i> Crear Nuevo Ticket</button>
            </div>
            <div class="col-md-auto">
                <button id="exportToCsvButton" class="btn btn-secondary-custom"><i class="fas fa-file-download"></i> Exportar a CSV</button>
            </div>
            <div id="appMessage" class="col-12 mt-3 alert" style="display:none;"></div> </div>


        <div class="row" id="ticketList">
            </div>

        <div class="mt-5 row justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7"> <h3 class="text-center section-title"><i class="fas fa-chart-pie me-2"></i> Estadísticas de Tickets por Prioridad</h3>
                 <div style="height: 300px; position: relative;  background-color: #fff; border-radius: 0.5rem; padding:1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <canvas id="priorityChart"></canvas>
                 </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createTicketModal" tabindex="-1" aria-labelledby="createTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 0.75rem;">
                <div class="modal-header card-header-custom">
                    <h5 class="modal-title" id="createTicketModalLabel"><i class="fas fa-file-alt me-2"></i>Crear Nuevo Ticket de Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: #FDF8F5;">
                    <form id="createTicketForm">
                        <div class="mb-3">
                            <label for="ticketTitulo" class="form-label">Título del Pedido</label>
                            <input type="text" class="form-control" id="ticketTitulo" required>
                        </div>
                        <div class="mb-3">
                            <label for="ticketDescripcion" class="form-label">Descripción del Pedido</label>
                            <textarea class="form-control" id="ticketDescripcion" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ticketPrioridad" class="form-label">Prioridad</label>
                                <select class="form-select" id="ticketPrioridad" required>
                                    <option value="Alta">Alta <i class="fas fa-exclamation-circle"></i></option>
                                    <option value="Media" selected>Media</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ticketEstado" class="form-label">Estado</label>
                                <select class="form-select" id="ticketEstado" required>
                                    <option value="Abierto" selected>Abierto</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ticketCliente" class="form-label">Nombre del Cliente</label>
                                <input type="text" class="form-control" id="ticketCliente" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ticketKilos" class="form-label">Kilogramos de Café</label>
                                <input type="number" class="form-control" id="ticketKilos" step="0.1" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ticketTipoProducto" class="form-label">Tipo de Producto</label>
                                <input type="text" class="form-control" id="ticketTipoProducto" placeholder="Ej. Arábica, Robusta, Mezcla" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ticketPaisEnvio" class="form-label">País de Envío</label>
                                <input type="text" class="form-control" id="ticketPaisEnvio" required>
                            </div>
                        </div>
                        <div id="formMessage" class="alert mt-2" style="display:none;"></div>
                        <button type="submit" class="btn btn-primary-custom mt-2"><i class="fas fa-check-circle"></i> Guardar Ticket</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 0.75rem;">
                <div class="modal-header" style="background-color: #E57373; color:white;">
                    <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que quieres eliminar este ticket? Esta acción no se puede deshacer.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times-circle"></i> Cancelar</button>
                    <button type="button" class="btn btn-danger-custom" id="confirmDeleteButton"><i class="fas fa-trash-alt"></i> Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-custom">
        Exportación de Café S.A. de C.V. &copy; <span id="currentYear"></span>. Todos los derechos reservados.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            sendPasswordResetEmail,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            Timestamp,
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD0JfkTCkP9RliCbKCjoIQqB5Q8egugFZ0", 
            authDomain: "ejercicio-2-75a22.firebaseapp.com",
            projectId: "ejercicio-2-75a22",
            storageBucket: "ejercicio-2-75a22.firebasestorage.app", 
            messagingSenderId: "730084399107",
            appId: "1:730084399107:web:dd3e9f559deee66e011636"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        setPersistence(auth, browserLocalPersistence)
            .catch((error) => {
                console.error("Error setting auth persistence: ", error);
            });

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const passwordResetForm = document.getElementById('passwordResetForm');
        const createTicketForm = document.getElementById('createTicketForm');
        const ticketList = document.getElementById('ticketList');
        const logoutButton = document.getElementById('logoutButton');
        const userInfoDisplay = document.getElementById('userInfo');
        const exportToCsvButton = document.getElementById('exportToCsvButton');
        const priorityChartCanvas = document.getElementById('priorityChart').getContext('2d');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const authMessageDiv = document.getElementById('authMessage'); // For auth section messages
        const formMessageDiv = document.getElementById('formMessage'); // For modal form messages
        const appMessageDiv = document.getElementById('appMessage'); // For general app messages (like CSV export)


        const loginFormContainer = document.getElementById('loginFormContainer');
        const registerFormContainer = document.getElementById('registerFormContainer');
        const passwordResetFormContainer = document.getElementById('passwordResetFormContainer');
        
        const showRegisterLink = document.getElementById('showRegister');
        const showPasswordResetLink = document.getElementById('showPasswordReset');
        const showLoginFromRegisterLink = document.getElementById('showLoginFromRegister');
        const showLoginFromResetLink = document.getElementById('showLoginFromReset');

        let priorityChart = null; 
        let currentUserId = null; 
        let confirmDeleteModalInstance = null; 
        let ticketToDeleteId = null; 

        // --- Utility Functions ---
        function showLoading() { loadingSpinner.style.display = 'flex'; } // Changed to flex for centering spinner-border
        function hideLoading() { loadingSpinner.style.display = 'none'; }

        function displayMessage(element, message, type = 'danger') {
            element.textContent = message;
            element.className = `alert alert-${type} mt-3`; // Ensure base alert class is present
            element.style.display = 'block';
             setTimeout(() => { element.style.display = 'none'; element.textContent = '';}, 5000); // Auto-hide after 5s
        }
        
        function clearMessage(element) {
            element.style.display = 'none';
            element.textContent = '';
        }


        // --- Auth View Toggling ---
        function showView(view) {
            loginFormContainer.style.display = 'none';
            registerFormContainer.style.display = 'none';
            passwordResetFormContainer.style.display = 'none';
            if (view === 'login') loginFormContainer.style.display = 'block';
            else if (view === 'register') registerFormContainer.style.display = 'block';
            else if (view === 'reset') passwordResetFormContainer.style.display = 'block';
            clearMessage(authMessageDiv);
        }

        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showView('register'); });
        showPasswordResetLink.addEventListener('click', (e) => { e.preventDefault(); showView('reset'); });
        showLoginFromRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });
        showLoginFromResetLink.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });


        // --- Firebase Auth Listener ---
        onAuthStateChanged(auth, async (user) => {
            showLoading();
            if (user) {
                currentUserId = user.uid;
                // Try to get user's name from Firestore, fallback to email
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists() && userDocSnap.data().name) {
                        userInfoDisplay.textContent = `Usuario: ${userDocSnap.data().name}`;
                    } else {
                        userInfoDisplay.textContent = `Usuario: ${user.email}`;
                    }
                } catch (e) {
                     userInfoDisplay.textContent = `Usuario: ${user.email}`; // Fallback
                }

                userInfoDisplay.classList.remove('d-none');
                logoutButton.classList.remove('d-none');
                authSection.style.display = 'none';
                appSection.style.display = 'block';
                loadTickets(); 
                if (!confirmDeleteModalInstance) {
                    confirmDeleteModalInstance = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                }
            } else {
                currentUserId = null;
                userInfoDisplay.classList.add('d-none');
                logoutButton.classList.add('d-none');
                authSection.style.display = 'block';
                appSection.style.display = 'none';
                ticketList.innerHTML = ''; 
                if (priorityChart) priorityChart.destroy(); 
                showView('login'); 
            }
            hideLoading();
        });

        // --- Authentication Functions ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            clearMessage(authMessageDiv);
            const email = loginEmail.value;
            const password = loginPassword.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error signing in:", error);
                displayMessage(authMessageDiv, `Error al iniciar sesión: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            clearMessage(authMessageDiv);
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (password.length < 6) {
                displayMessage(authMessageDiv, "La contraseña debe tener al menos 6 caracteres.");
                hideLoading();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const usersCollectionPath = `artifacts/${appId}/public/data/users`;
                await setDoc(doc(db, usersCollectionPath, user.uid), {
                    name: name,
                    email: user.email,
                    createdAt: Timestamp.now()
                });
                // onAuthStateChanged handles UI update
            } catch (error) {
                console.error("Error registering:", error);
                displayMessage(authMessageDiv, `Error al registrar: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        passwordResetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            clearMessage(authMessageDiv);
            const email = document.getElementById('resetEmail').value;
            try {
                await sendPasswordResetEmail(auth, email);
                displayMessage(authMessageDiv, "Se ha enviado un enlace para restablecer la contraseña a tu correo.", "success");
            } catch (error) {
                console.error("Error sending password reset email:", error);
                displayMessage(authMessageDiv, `Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        logoutButton.addEventListener('click', async () => {
            showLoading();
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                displayMessage(authMessageDiv, `Error al cerrar sesión: ${error.message}`); // This message might not be visible if redirected
            } finally {
                hideLoading();
            }
        });

        // --- Ticket Management ---
        const ticketsCollectionPath = `artifacts/${appId}/public/data/tickets`;
        const metadataCollectionPath = `artifacts/${appId}/public/data/metadata`;
        const ticketCounterDocRef = doc(db, metadataCollectionPath, 'ticketCounterDoc');

        async function getNextFolio() {
            try {
                const counterDocSnap = await getDoc(ticketCounterDocRef);
                let lastFolioNumber = 0;
                if (counterDocSnap.exists()) {
                    lastFolioNumber = counterDocSnap.data().lastFolioNumber || 0;
                }
                const nextFolioNumber = lastFolioNumber + 1;
                await setDoc(ticketCounterDocRef, { lastFolioNumber: nextFolioNumber }, { merge: true });
                return `COFFEE-${String(nextFolioNumber).padStart(4, '0')}`; // Padded to 4 digits
            } catch (error) {
                console.error("Error generating folio:", error);
                return `COFFEE-ERR-${Date.now().toString().slice(-4)}`; 
            }
        }

        createTicketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            clearMessage(formMessageDiv);

            const newTicket = {
                titulo: document.getElementById('ticketTitulo').value,
                descripcion: document.getElementById('ticketDescripcion').value,
                prioridad: document.getElementById('ticketPrioridad').value,
                estado: document.getElementById('ticketEstado').value,
                cliente: document.getElementById('ticketCliente').value,
                kilos: parseFloat(document.getElementById('ticketKilos').value),
                tipoProducto: document.getElementById('ticketTipoProducto').value,
                paisEnvio: document.getElementById('ticketPaisEnvio').value,
                folio: await getNextFolio(),
                creadoPorUid: currentUserId, // Storing UID
                creadoPorEmail: auth.currentUser.email, // Storing Email for display convenience
                fechaCreacion: Timestamp.now()
            };

            try {
                await addDoc(collection(db, ticketsCollectionPath), newTicket);
                createTicketForm.reset();
                bootstrap.Modal.getInstance(document.getElementById('createTicketModal')).hide();
                displayMessage(appMessageDiv, "Ticket creado exitosamente.", "success");
            } catch (error) {
                console.error("Error creating ticket:", error);
                displayMessage(formMessageDiv, `Error al crear ticket: ${error.message}`, "danger");
            } finally {
                hideLoading();
            }
        });
        
        function loadTickets() {
            if (!currentUserId) return; 
            showLoading();
            const q = query(collection(db, ticketsCollectionPath)); 

            onSnapshot(q, (querySnapshot) => {
                const tickets = [];
                querySnapshot.forEach((doc) => {
                    tickets.push({ id: doc.id, ...doc.data() });
                });
                tickets.sort((a, b) => b.fechaCreacion.toMillis() - a.fechaCreacion.toMillis());

                renderTickets(tickets);
                updatePriorityChart(tickets);
                hideLoading();
            }, (error) => {
                console.error("Error loading tickets: ", error);
                ticketList.innerHTML = '<p class="text-danger col-12">Error al cargar los tickets.</p>';
                hideLoading();
            });
        }

        function getPriorityClass(prioridad) {
            if (prioridad === 'Alta') return 'priority-alta';
            if (prioridad === 'Media') return 'priority-media';
            if (prioridad === 'Baja') return 'priority-baja';
            return '';
        }
        
        function getStatusBadge(estado) {
            const statusClass = estado === 'Abierto' ? 'status-abierto' : 'status-cerrado';
            return `<span class="${statusClass}"><i class="fas ${estado === 'Abierto' ? 'fa-door-open' : 'fa-door-closed'} me-1"></i>${estado}</span>`;
        }

        function renderTickets(tickets) {
            ticketList.innerHTML = '';
            if (tickets.length === 0) {
                ticketList.innerHTML = '<p class="col-12 text-center fst-italic">No hay tickets activos en este momento.</p>';
                return;
            }
            tickets.forEach(ticket => {
                const priorityIcon = ticket.prioridad === 'Alta' ? 'fa-angles-up' : ticket.prioridad === 'Media' ? 'fa-arrows-left-right' : 'fa-angles-down';
                const ticketCard = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-ticket-alt me-2"></i>${ticket.folio}</span>
                                <button class="btn btn-sm btn-danger-custom delete-ticket-btn" data-id="${ticket.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title" style="color: #5D4037;">${ticket.titulo}</h5>
                                <p class="card-text"><strong><i class="fas fa-user-tie me-1"></i>Cliente:</strong> ${ticket.cliente}</p>
                                <p class="card-text flex-grow-1"><strong><i class="fas fa-align-left me-1"></i>Desc:</strong> ${ticket.descripcion.substring(0,100)}${ticket.descripcion.length > 100 ? '...' : ''}</p>
                                <p class="card-text"><strong><i class="fas fa-layer-group me-1"></i>Prioridad:</strong> <span class="${getPriorityClass(ticket.prioridad)}"><i class="fas ${priorityIcon} me-1"></i>${ticket.prioridad}</span></p>
                                <p class="card-text"><strong><i class="fas fa-info-circle me-1"></i>Estado:</strong> ${getStatusBadge(ticket.estado)}</p>
                                <p class="card-text"><strong><i class="fas fa-weight-hanging me-1"></i>Kg:</strong> ${ticket.kilos}</p>
                                <p class="card-text"><strong><i class="fas fa-mug-saucer me-1"></i>Tipo:</strong> ${ticket.tipoProducto}</p>
                                <p class="card-text"><strong><i class="fas fa-globe-americas me-1"></i>País:</strong> ${ticket.paisEnvio}</p>
                                <p class="card-text mt-auto"><small class="text-muted"><i class="fas fa-user-clock me-1"></i>${ticket.creadoPorEmail || 'Desconocido'} - ${ticket.fechaCreacion.toDate().toLocaleDateString()}</small></p>
                            </div>
                        </div>
                    </div>
                `;
                ticketList.innerHTML += ticketCard;
            });

            document.querySelectorAll('.delete-ticket-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    ticketToDeleteId = e.currentTarget.dataset.id;
                    if(confirmDeleteModalInstance) {
                         confirmDeleteModalInstance.show();
                    } else { 
                        // Fallback, should not happen if modal is initialized correctly
                        if(window.confirm("¿Estás seguro de que quieres eliminar este ticket?")) { // window.confirm is fallback
                            deleteTicket(ticketToDeleteId);
                        }
                    }
                });
            });
        }
        
        document.getElementById('confirmDeleteButton').addEventListener('click', () => {
            if (ticketToDeleteId) {
                deleteTicket(ticketToDeleteId);
            }
            if(confirmDeleteModalInstance) confirmDeleteModalInstance.hide();
        });

        async function deleteTicket(id) {
            if (!currentUserId) {
                displayMessage(appMessageDiv, "Debes estar autenticado para eliminar tickets.");
                return;
            }
            showLoading();
            try {
                await deleteDoc(doc(db, ticketsCollectionPath, id));
                displayMessage(appMessageDiv, "Ticket eliminado correctamente.", "success");
            } catch (error) {
                console.error("Error deleting ticket:", error);
                displayMessage(appMessageDiv, `Error al eliminar ticket: ${error.message}`, "danger");
            } finally {
                hideLoading();
                ticketToDeleteId = null; 
            }
        }

        exportToCsvButton.addEventListener('click', async () => {
            showLoading();
            clearMessage(appMessageDiv);
            try {
                const q = query(collection(db, ticketsCollectionPath));
                const querySnapshot = await getDocs(q); 
                const tickets = [];
                querySnapshot.forEach(doc => tickets.push({ id: doc.id, ...doc.data() }));
                
                if (tickets.length === 0) {
                    displayMessage(appMessageDiv, "No hay tickets para exportar.", "warning");
                    hideLoading();
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = ["Folio", "Título", "Descripción", "Prioridad", "Estado", "Cliente", "Kilos Café", "Tipo Producto", "País Envío", "Creado Por Email", "Fecha Creación"];
                csvContent += headers.join(",") + "\r\n";

                tickets.forEach(ticket => {
                    const row = [
                        ticket.folio,
                        `"${(ticket.titulo || '').replace(/"/g, '""')}"`, 
                        `"${(ticket.descripcion || '').replace(/"/g, '""')}"`,
                        ticket.prioridad,
                        ticket.estado,
                        `"${(ticket.cliente || '').replace(/"/g, '""')}"`,
                        ticket.kilos,
                        `"${(ticket.tipoProducto || '').replace(/"/g, '""')}"`,
                        `"${(ticket.paisEnvio || '').replace(/"/g, '""')}"`,
                        ticket.creadoPorEmail || 'N/A',
                        ticket.fechaCreacion.toDate().toISOString()
                    ];
                    csvContent += row.join(",") + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "tickets_cafe_exportacion.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                displayMessage(appMessageDiv, "Datos exportados a CSV exitosamente.", "success");

            } catch (error) {
                console.error("Error exporting to CSV:", error);
                displayMessage(appMessageDiv, "Error al exportar los datos a CSV.", "danger");
            } finally {
                hideLoading();
            }
        });

        function updatePriorityChart(tickets) {
            const priorityCounts = { Alta: 0, Media: 0, Baja: 0 };
            tickets.forEach(ticket => {
                if (priorityCounts.hasOwnProperty(ticket.prioridad)) {
                    priorityCounts[ticket.prioridad]++;
                }
            });

            if (priorityChart) {
                priorityChart.destroy(); 
            }

            priorityChart = new Chart(priorityChartCanvas, {
                type: 'bar',
                data: {
                    labels: ['Alta', 'Media', 'Baja'],
                    datasets: [{
                        label: 'Cantidad de Tickets',
                        data: [priorityCounts.Alta, priorityCounts.Media, priorityCounts.Baja],
                        backgroundColor: [
                            'rgba(229, 115, 115, 0.7)', // Softer Red (Alta)
                            'rgba(255, 183, 77, 0.7)',  // Softer Orange/Yellow (Media)
                            'rgba(129, 199, 132, 0.7)'   // Softer Green (Baja)
                        ],
                        borderColor: [
                            'rgba(229, 115, 115, 1)',
                            'rgba(255, 183, 77, 1)',
                            'rgba(129, 199, 132, 1)'
                        ],
                        borderWidth: 1,
                        borderRadius: 5 // Rounded bars
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#4A3B31' // Axis text color
                            },
                            grid: {
                                color: '#E0D6CC' // Grid line color
                            }
                        },
                        x: {
                             ticks: {
                                color: '#4A3B31' // Axis text color
                            },
                            grid: {
                                display: false // Hide x-axis grid lines
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#4A3B31' // Legend text color
                            }
                        }
                    }
                }
            });
        }
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();

    </script>
</body>
</html>
